{"remainingRequest":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js??ref--0-2!/home/darkcrossunicorn/文档/admin/src/pages/kefu/appChat/mobile/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/darkcrossunicorn/文档/admin/src/pages/kefu/appChat/mobile/index.vue","mtime":1661152956000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js","mtime":1570440814000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport Setting from '@/setting';\nimport { Socket } from '@/libs/socket';\nimport util from '@/libs/util';\nimport emojiList from '@/utils/emoji'\nimport { serviceListApi, getOrderApi, chatListApi, productApi } from '@/api/kefu'\n\nconst chunk = function (arr, num) {\n    num = num * 1 || 1;\n    var ret = [];\n    arr.forEach(function (item, i) {\n        if (i % num === 0) {\n            ret.push([]);\n        }\n        ret[ret.length - 1].push(item);\n    });\n    return ret;\n};\n\nexport default {\n    name: 'chat_mobile',\n    data () {\n        return {\n            ops: {\n                vuescroll: {\n                    mode: 'slide',\n                    enable: false,\n                    auto: false,\n                    autoLoadDistance: 0,\n                    pullRefresh: {\n                        enable: true,\n                        auto: false,\n                        autoLoadDistance: 0,\n                        tips: {\n                            deactive: '',\n                            active: '上拉加载更多',\n                            start: 'Loading...',\n                            beforeDeactive: ' '\n                        }\n                    },\n                    pushLoad: {\n                        enable: false\n\n                    }\n                },\n                bar: {\n                    background: '#393232',\n                    opacity: '.5',\n                    size: '2px'\n                }\n            },\n            swiperOptions: {},\n            status: false,\n            loading: false,\n            isTool: false,\n            isSwiper: false,\n            isWords: false,\n            autoplay: false,\n            circular: true,\n            interval: 3000,\n            duration: 500,\n            emojiGroup: chunk(emojiList, 21),\n            con: '',\n            toUid: '',\n            limit: 15,\n            upperId: 0,\n            chatList: [],\n            kefuInfo: {},\n            scrollTop: 0,\n            active: true,\n            isScroll: true,\n            oldHeight: 0,\n            selector: '',\n            transferList: [], // 转接列表\n            isTransfer: false,\n            uploadData: {}, // 上传参数\n            header: {},\n            fileUrl: '',\n            userToken: '',\n            tourist_uid: '', // 游客的uid\n            orderId: '',\n            orderInfo: '',\n            cartInfo: '',\n            productId: '',\n            productInfo: '',\n            tourist_avatar: '',\n            pageWs:''\n        }\n    },\n    computed: {\n        isSend () {\n            if (this.con.length == 0) {\n                return false\n            } else {\n                return true\n            }\n        },\n        records () {\n            return this.chatList.map((item, index) => {\n                item.time = this.$moment(item.add_time * 1000).format('MMMDo h:mm')\n                if (index) {\n                    if (\n                        item.add_time -\n                        this.chatList[index - 1].add_time >=\n                        300\n                    ) {\n                        item.show = true;\n                    } else {\n                        item.show = false;\n                    }\n                } else {\n                    item.show = true;\n                }\n                return item;\n            });\n        }\n    },\n    created () {\n        let token = localStorage.getItem('LOGIN_STATUS_TOKEN') || ''\n        this.fileUrl = Setting.apiBaseURL.replace('adminapi', 'kefuapi') + '/tourist/upload'\n        this.userToken = token\n        this.toUid = this.$route.query.toUid || ''\n        this.nickname = this.$route.query.nickname || ''\n        this.orderId = this.$route.query.orderId || ''\n        this.productId = this.$route.query.product_id || ''\n    },\n    mounted () {\n        if (!this.$wechat._isMobile()) this.$router.replace('/kefu/appChat');\n        let that = this;\n        this.getServiceList()\n        if (this.userToken) {\n            this.getOrderInfo()\n            this.getGoodsInfo()\n        }\n        // 上传头部token\n        this.header['Authori-zation'] = 'Bearer ' + this.userToken;\n        this.pageWs = Socket(true)\n        this.$nextTick(() => {\n            this.wsStart()\n        })\n    },\n    methods: {\n        goBack(){\n            this.$router.go(-1);\n        },\n        wsStart(){\n            let that = this\n            this.pageWs.then(ws => {\n                if (this.userToken) {\n                    ws.send({\n                        type: 'login',\n                        data: this.userToken\n                    })\n                }\n                // 消息接收\n                ws.$on(['reply', 'chat'], data => {\n                    if (data.msn_type == 1 || data.msn_type == 2) {\n                        data.msn = this.replace_em(data.msn)\n                    }\n                    this.chatList.push(data)\n                    this.$nextTick(() => {\n                        this.$refs['scrollBox'].refresh();\n                        this.scrollBom()\n                    })\n                    setTimeout(res => {\n                        this.$refs['scrollBox'].refresh();\n                    }, 300)\n                });\n                ws.$on('socket_error', () => {\n                    this.$Message.error('连接失败')\n                });\n                ws.$on('error', () => {\n                    this.$Message.error('连接失败')\n                });\n                ws.$on('to_transfer', data => {\n                    ws.send({\n                        data: {\n                            id: data.toUid\n                        },\n                        type: 'to_chat'\n                    });\n                })\n                ws.$on('online', data => {\n                    if (data.online == 0 && data.uid == that.toUid) {\n                        that.$Modal.confirm({\n                            title: '提示',\n                            content: '客服已离线，是否需要反馈？',\n                            okText: '确定',\n                            cancelText: '取消',\n                            onOk: () => {\n                                that.$router.replace({\n                                    path: '/kefu/mobile_feedback'\n                                })\n                            }\n                        });\n                    }\n                });\n                ws.$on('timeout', data => {\n                    setTimeout(()=>{\n                        this.wsRestart()\n                    },2000)\n                })\n            }).catch(error=>{\n                setTimeout(res=>{\n                    this.wsRestart()\n                },2000)\n            });\n        },\n        wsRestart(){\n            this.pageWs = Socket(true)\n            this.wsStart()\n        },\n        handleFormatError (file) {\n            this.$Message.error('上传图片只能是 jpg、jpg、jpeg、gif 格式!');\n        },\n        // 获取商品信息\n        getGoodsInfo () {\n            if (!this.productId) return\n            productApi(this.productId).then((res) => {\n                this.productInfo = res.data;\n            }).catch((err) => {\n                this.$Message.error(err.msg);\n            });\n        },\n        // 获取订单信息\n        getOrderInfo () {\n            if (!this.orderId) return\n            getOrderApi(this.orderId, {\n                token: this.userToken\n            }).then(res => {\n                this.orderInfo = res.data;\n                if (this.orderInfo.add_time_h) {\n                    this.orderInfo.add_time_h = this.orderInfo.add_time_h.substring(\n                        0,\n                        this.orderInfo.add_time_h.lastIndexOf(':')\n                    );\n                }\n                if (this.orderInfo.cartInfo.length) {\n                    this.cartInfo = this.orderInfo.cartInfo[0];\n                }\n            })\n        },\n        // 获取随机客服\n        getServiceList () {\n            serviceListApi({\n                token: this.userToken\n            }).then(res => {\n                this.toUid = res.data.uid;\n                this.tourist_uid = res.data.tourist_uid\n                document.title = res.data.nickname\n                this.tourist_avatar = res.data.tourist_avatar\n                if (this.userToken) {\n                    this.getChatList();\n                }\n                let obj = {\n                    data: {\n                        id: res.data.uid,\n                        tourist_uid: this.tourist_uid\n                    },\n                    type: 'to_chat'\n                }\n                this.pageWs.then(ws => {\n                    ws.send(obj)\n                })\n            }).catch(error => {\n                this.$Message.error(error.msg)\n                setTimeout(res => {\n                    this.$router.replace({\n                        path: '/kefu/mobile_feedback'\n                    })\n                }, 2000)\n            })\n        },\n        // 上传之前\n        beforeUpload (file) {\n            const isImage = file.type === 'image/jpeg' || file.type === 'image/png';\n            if (!isImage) {\n                this.$Message.error('上传图片只能是 JPG、PNG 格式!');\n            }\n            this.uploadData = {\n                filename: file,\n                token: this.userToken\n            }\n            let promise = new Promise((resolve) => {\n                this.$nextTick(function () {\n                    resolve(true);\n                });\n            });\n            return promise;\n        },\n        // 上传成功\n        handleSuccess (res, file, fileList) {\n            if (res.status === 200) {\n                this.$Message.success(res.msg);\n                this.sendMsg(res.data.url, 3)\n            } else {\n                this.$Message.error(res.msg);\n            }\n        },\n        // 滚动到底部\n        scrollBom () {\n            setTimeout(res => {\n                let num = parseFloat(document.getElementById('chatBox').offsetHeight)\n                if (this.$refs['scrollBox']) {\n                    this.$refs['scrollBox'].scrollTo(\n                        {\n                            y: num\n                        },\n                        300\n                    );\n                }\n            }, 300)\n        },\n        // 订单详情\n        goOrderDetail (item) {\n            this.$router.push({\n                path: `/kefu/orderDetail/${item.orderInfo.id}`\n            })\n        },\n        // 底部功能区打开\n        openBox (key) {\n            if (key == 1) {\n                this.isTool = false\n                this.isSwiper = !this.isSwiper\n            } else {\n                this.isSwiper = false\n                this.isTool = !this.isTool\n            }\n            this.$refs['scrollBox'].refresh();\n            this.$nextTick(() => {\n                this.scrollBom();\n            })\n        },\n        showWords () {\n            this.isWords = true\n        },\n\n        // 转接\n        goTransfer () {\n            this.isTransfer = true\n        },\n        // 转接关闭\n        closeTransfer () {\n            this.transferList.forEach((el, index) => {\n                el.isCheck = false\n            })\n            this.isTransfer = false\n        },\n        // 商品信息\n        goodsInfo () {\n            this.$router.push({\n                path: '/kefu/goods/list?toUid=' + this.toUid\n            })\n        },\n        // 表情点击\n        addEmoji (item) {\n            let val = `[${item}]`\n            this.con += val\n        },\n        // 聊天表情转换\n        replace_em (str) {\n            str = str.replace(/\\[em-([\\s\\S]*)\\]/g, \"<span class='em em-$1'/></span>\");\n            return str;\n        },\n        // 获取聊天列表\n        getChatList () {\n            let self = this\n            chatListApi({\n                limit: this.limit,\n                uid: this.toUid,\n                upperId: this.upperId,\n                token: this.userToken\n            }).then(res => {\n                var sH = 0\n                res.data.forEach(el => {\n                    if (el.msn_type == 1 || el.msn_type == 2) {\n                        el.msn = this.replace_em(el.msn)\n                    }\n                })\n                let selector = ''\n                if (this.upperId == 0) {\n                    selector = `chat_${res.data[res.data.length - 1].id}`;\n                } else {\n                    selector = `chat_${this.chatList[0].id}`;\n                }\n                this.selector = selector\n                this.chatList = [...res.data, ...this.chatList];\n                this.loading = false\n                this.isScroll = res.data.length >= this.limit\n                this.$refs['scrollBox'].refresh();\n                this.$nextTick(() => {\n                    this.$emit('change', true)\n                    let num = parseFloat(document.getElementById(selector).offsetTop) - 60\n                    this.$refs['scrollBox'].scrollTo(\n                        {\n                            y: num\n                        },\n                        0\n                    );\n                })\n            })\n        },\n        // 发送订单\n        sendOrder () {\n            this.sendMsg(this.orderId, 6);\n            this.orderId = 0;\n            this.orderInfo = {};\n        },\n        // 发送商品\n        sendProduct () {\n            this.sendMsg(this.productId, 5);\n            this.productId = 0;\n            this.productInfo = {};\n        },\n        // 发送消息\n        sendText () {\n            if (!this.isSend) {\n                this.$Message.error('请输入内容')\n            }\n            this.sendMsg(this.con, 1);\n            this.con = ''\n        },\n        // ws发送\n        sendMsg (msn, type) {\n            let obj = {\n                type: 'chat',\n                data: {\n                    msn,\n                    type,\n                    is_tourist: this.userToken ? 0 : 1,\n                    to_uid: this.toUid,\n                    tourist_uid: this.tourist_uid,\n                    form_type: this.$wechat.isWeixin() ? 1 : 3,\n                    tourist_avatar: this.userToken ? '' : this.tourist_avatar\n                }\n            }\n            this.pageWs.then(ws => {\n                ws.send(obj)\n            })\n        },\n        // 图片上传\n        uploadImg () {\n            let self = this\n            self.$util.uploadImageOne('upload/image', function (res) {\n                if (res.status == 200) {\n                    self.sendMsg(res.data.url, 3)\n                }\n            });\n        },\n        //  商品详情页\n        goProduct (item) {\n            let url = window.location.protocol + '//' + window.location.host + '/pages/goods_details/index?id=' + item.msn;\n            window.open(url, '_blank');\n        },\n        // 用户订单\n        goAdminOrder () {\n            // this.$router.push({\n            //     path:'/kefu/orderList/0/'+this.toUid\n            // })\n            let url = window.location.protocol + '//' + window.location.host + '/pages/goods/order_details/index?order_id=' + item.msn;\n            window.open(url, '_blank');\n        },\n        // 滚动到底部\n        height () {\n            let self = this\n            var scrollTop = 0\n            let info = uni.createSelectorQuery().select('.chat');\n            setTimeout(res => {\n                info.boundingClientRect(function (data) { // data - 各种参数\n                    scrollTop = data.height\n                    if (self.active) {\n                        self.scrollTop = parseInt(scrollTop) + 500\n                    } else {\n                        self.scrollTop = parseInt(scrollTop) + 100\n                    }\n                }).exec()\n            }, 1000)\n        },\n        handleActivate (vm, refreshDom) {\n            this.upperId = this.chatList[0].id\n        },\n        handleStart (vm, refreshDom, done) {\n            setTimeout(() => {\n                // load finished\n                done();\n            }, 2000)\n        },\n        handleBeforeDeactivate (vm, refreshDom, done) {\n            if (this.userToken) {\n                this.getChatList()\n                this.$on('change', data => {\n                    if (data) done();\n                })\n            } else {\n                done();\n            }\n        },\n        handleDeactivate (vm, refreshDom) {\n            let num = parseFloat(document.getElementById(this.selector).offsetTop) - 60\n            this.$refs['scrollBox'].scrollTo(\n                {\n                    y: num\n                },\n                0\n            );\n        }\n    }\n}\n",null]}