{"remainingRequest":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js??ref--0-2!/home/darkcrossunicorn/文档/admin/src/pages/kefu/mobile/chat_list.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/darkcrossunicorn/文档/admin/src/pages/kefu/mobile/chat_list.vue","mtime":1658973957000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js","mtime":1570440814000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n    import util from '@/libs/util';\n    import { Socket } from '@/libs/socket';\n    import { record } from '@/api/kefu.js'\n    import { serviceInfo } from '@/api/kefu_mobile'\n    import { HappyScroll } from 'vue-happy-scroll'\n    import { mapState, mapActions } from 'vuex';\n\n    import empty from '../components/empty';\n    import cookies from '../../../libs/util.cookies';\n    var mp3 = require('@/assets/video/notice.wav');\n    var mp3 = new Audio(mp3);\n    export default {\n        name: 'chat_list.vue',\n        components: {\n            HappyScroll,\n            empty\n        },\n        data () {\n            return {\n                ops: {\n                    vuescroll: {\n                        mode: 'native',\n                        enable: false,\n                        tips: {\n                            deactive: 'Push to Load',\n                            active: 'Release to Load',\n                            start: 'Loading...',\n                            beforeDeactive: 'Load Successfully!'\n                        },\n                        auto: false,\n                        autoLoadDistance: 0,\n                        pullRefresh: {\n                            enable: false\n                        },\n                        pushLoad: {\n                            enable: true,\n                            auto: true,\n                            autoLoadDistance: 10\n                        }\n                    },\n                    bar: {\n                        background: '#393232',\n                        opacity: '.5',\n                        size: '5px'\n                    }\n                },\n                list: [],\n                page: 1,\n                limit: 10,\n                isScroll: true,\n                searchTxt: '',\n                isOpen: true,\n                kefuInfo: {},\n                isOnLine: false,\n                tabCur: 0,\n                tabList: [\n                    {\n                        key: 0,\n                        title: '用户列表'\n                    },\n                    {\n                        key: 1,\n                        title: '游客列表'\n                    }\n                ],\n                wsLogin: JSON.parse(sessionStorage.getItem('wsLogin')),\n                pageWs:''\n            }\n        },\n        filters: {\n            toDay: function (value) {\n                if (!value) return ''\n                var date = new Date();// 时间戳为10位需*1000，时间戳为13位的话不需乘1000\n                var Y = date.getFullYear() + '-';\n                var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';\n                var D = (date.getDate() < 10 ? '0' + date.getDate() : date.getDate()) + ' ';\n                var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';\n                var m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes());\n                var s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds());\n\n                value = M + D + h + m;\n                return value;\n            }\n        },\n        created () {\n            Promise.all([this.getKefuInfo(), this.getList()]);\n            if(typeof this.bus.pageWs == 'undefined'){\n                this.bus.pageWs = Socket(true)\n                this.wsKefuLogin()\n            }else{\n                this.wsStart()\n            }\n        },\n        mounted () {\n            let that = this;\n            // 监听页面刷新\n            window.addEventListener('beforeunload', e => {\n                sessionStorage.setItem('wsLogin', false);\n            });\n            // 获取是否登录的key\n            this.wsLogin = JSON.parse(sessionStorage.getItem('wsLogin')) || false;\n\n\n        },\n        methods: {\n            ...mapActions('admin/account', [\n                'logout',\n                'logoutKefu'\n            ]),\n            wsKefuLogin(){\n                let that = this\n                let token = util.cookies.kefuGet('token')\n                this.bus.pageWs.then(ws => {\n                    if (!that.wsLogin && token) {\n                        ws.send({\n                            type: 'kefu_login',\n                            data: token\n                        })\n                    }\n                    // 消息接收\n                    ws.$on('success', data => {\n                        sessionStorage.setItem('wsLogin', true);\n                        this.wsStart()\n                    });\n                    ws.$on('timeout', data => {\n                        setTimeout(()=>{\n                            this.wsRestart()\n                        },2000)\n                    });\n                }).catch(error=>{\n                    setTimeout(()=>{\n                        this.wsRestart()\n                    },2000)\n                })\n\n            },\n            wsStart(){\n                let that = this\n                let token = util.cookies.kefuGet('token')\n                this.bus.pageWs.then(ws => {\n                    // 用户未读消息条数更改\n                    ws.$on('transfer', data => {\n                        if (data.recored.id) {\n                            let status = false\n                            for (let i = 0; i < this.list.length; i++) {\n                                if (data.recored.id == this.list[i].id) {\n                                    status = true\n                                    this.$set(this.list, i, data.recored)\n                                }\n                            }\n                            if (!status) {\n                                this.list.unshift(data.recored)\n                            }\n                        }\n                    })\n                    ws.$on('mssage_num', data => {\n                        if(data.num>0){\n                            mp3.play();\n                        }\n                        if(data.recored.id){\n                            let status = false\n                            that.list.forEach((el,index,arr)=>{\n                                if(data.recored.id == el.id){\n                                    status = true\n                                    if(data.recored.is_tourist == that.tabCur){\n                                        let oldVal = data.recored\n                                        arr.splice(index,1)\n                                        arr.unshift(oldVal)\n                                    }\n\n                                }\n                            })\n                            if(!status){\n                                if(data.recored.is_tourist == this.tabCur)\n                                    this.userList.unshift(data.recored)\n                            }\n                            if(data.recored.is_tourist != this.tabCur && data.recored.id){\n                                this.$Notice.info({\n                                    title: this.tabCur?'用户发来消息啦！':'游客发来消息啦！',\n                                });\n                            }\n\n                        }\n                    })\n                    ws.$on('timeout', data => {\n                        setTimeout(()=>{\n                            this.wsRestart()\n                        },2000)\n                    })\n                }).catch(error=>{\n                    setTimeout(res=>{\n                        this.wsRestart()\n                    },2000)\n                });\n            },\n            wsRestart(){\n                this.bus.pageWs = Socket(true)\n                this.wsKefuLogin()\n            },\n            // 列表切换\n            changeClass (item) {\n                if (this.tabCur == item.key) return\n                this.tabCur = item.key\n                this.page = 1\n                this.list = []\n                this.isScroll = true\n                this.getList()\n            },\n            // 客服上下线\n            changOnline (key) {\n                this.kefuInfo.online = key\n                this.isOnLine = false\n                this.bus.pageWs.then(ws => {\n                    let that = this;\n                    ws.send({\n                        type: 'online',\n                        data: {\n                            online: key\n                        }\n                    })\n                });\n            },\n            // 客服详细信息\n            getKefuInfo () {\n                serviceInfo().then(res => {\n                    this.kefuInfo = res.data\n                    window.document.title = `${res.data.site_name} - 消息列表`\n                })\n            },\n            getList () {\n                if (!this.isScroll) return\n                record({\n                    nickname: this.searchTxt,\n                    page: this.page,\n                    limit: this.limit,\n                    is_tourist: this.tabCur\n                }).then(res => {\n                    this.isScroll = res.data.length >= this.limit\n                    this.list = this.list.concat(res.data)\n                    this.page++\n\t\t\t\t\t\t\t\t\t\tif(res.data.length){\n\t\t\t\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\t\t\t    this.$refs.vs.refresh();\n\t\t\t\t\t\t\t\t\t\t\t}, 100)\n\t\t\t\t\t\t\t\t\t\t}\n                })\n            },\n            // 客服退出\n            outLogin () {\n                let self = this\n                this.$Modal.confirm({\n                    title: '退出登录确认',\n                    content: '您确定退出登录当前账户吗？打开的标签页和个人设置将会保存。',\n                    onOk: () => {\n                        self.logoutKefu({\n                            confirm: false,\n                            vm: self\n                        });\n                    },\n                    onCancel: () => {\n                    }\n                });\n            },\n            // 搜索\n            bindSearch (e) {\n                this.page = 1\n                this.list = []\n                this.isScroll = true\n                this.getList()\n            },\n            // 进入对话\n            goPage (item) {\n                this.$router.push({\n                    path: 'mobile_chat',\n                    query: {\n                        toUid: item.to_uid,\n                        nickname: item.nickname,\n                        is_tourist: this.tabCur\n                    }\n                })\n            },\n            handleBeforeDeactivate (vm, refreshDom, done) {\n                this.getList();\n                done();\n            }\n\n        }\n    }\n",null]}