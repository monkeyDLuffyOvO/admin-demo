{"remainingRequest":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js??ref--0-2!/home/darkcrossunicorn/文档/admin/src/pages/marketing/addPiecesDiscount/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/darkcrossunicorn/文档/admin/src/pages/marketing/addPiecesDiscount/index.vue","mtime":1652425470000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js","mtime":1570440814000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { mapState,mapMutations } from \"vuex\";\nimport {\n\tsaveDiscount,\n\tdiscountInfo\n} from \"@/api/marketing\";\nimport {\n\tuserLabelAddApi\n} from \"@/api/user\";\nimport userLabel from \"@/components/labelList\";\nimport goodsList from '@/components/goodsList'\nexport default {\n\tname: \"addPiecesDiscount\",\n\tcomponents: {\n\t\tuserLabel,\n\t\tgoodsList\n\t},\n\tdata(){\n\t\treturn {\n\t\t\tgrid: {\n\t\t\t  xl: 7,\n\t\t\t  lg: 7,\n\t\t\t  md: 12,\n\t\t\t  sm: 24,\n\t\t\t  xs: 24,\n\t\t\t},\n\t\t\tmodals: false,\n\t\t\ttableData: [],\n\t\t\theadTab: [\n\t\t\t  {\n\t\t\t    name: \"基础设置\",\n\t\t\t    type: '1',\n\t\t\t  },\n\t\t\t  {\n\t\t\t    name: \"添加商品\",\n\t\t\t    type: '2',\n\t\t\t  }\n\t\t\t],\n\t\t\tdiscountType: [\n\t\t\t\t{ name: \"第2件半价\", title: \"例：甜筒第2件半价\", id: 1 },\n\t\t\t\t{ name: \"买1送1\", title: \"例：T恤买1送1\", id: 2 },\n\t\t\t\t{ name: \"自定义优惠\", title: \"例：第3件打5折\", id: 3 }\n\t\t\t],\n\t\t\tactivityType:[\n\t\t\t\t{\n\t\t\t\t\tname:'优惠券',\n\t\t\t\t\ttype:'5'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tname:'满减满折',\n\t\t\t\t\ttype:'3'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tname:'限时折扣',\n\t\t\t\t\ttype:'1'\n\t\t\t\t},\n\t\t\t\t// {\n\t\t\t\t// \tname:'满送活动',\n\t\t\t\t// \ttype:'4'\n\t\t\t\t// }\n\t\t\t],\n\t\t\tcurrentTab: '1',\n\t\t\tdataLabel:[],\n\t\t\tlabelShow:false,\n\t\t\tformValidate: {\n\t\t\t\tname:'',\n\t\t\t\tsection_time:[],\n\t\t\t\tdiscount: 50,\n\t\t\t\tthreshold: 2,\n\t\t\t\tis_label:0,\n\t\t\t\tlabel_id: [],\n\t\t\t\tis_overlay:'0',\n\t\t\t\toverlay:[],\n\t\t\t\tproduct_partake_type:1,\n\t\t\t\tproduct_id:[],\n\t\t\t\tn_piece_n_discount:1\n\t\t\t},\n\t\t\truleValidate: {\n\t\t\t\tname: [\n\t\t\t\t    { required: true, message: '请输入活动名称', trigger: 'blur' }\n\t\t\t\t],\n\t\t\t\tsection_time: [\n\t\t\t\t    { required: true, type: 'array', message: '请选择活动时间', trigger: 'change' }\n\t\t\t\t],\n\t\t\t\tis_overlay: [\n\t\t\t\t\t  { required: true, message: '请设置优惠叠加', trigger: 'change' }\n\t\t\t\t],\n\t\t\t\tthreshold: [\n\t\t\t\t\t  { type: 'number', required: true, message: '请填写优惠设置', trigger: 'blur' }\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t},\n\tcomputed: {\n\t  ...mapState(\"admin/layout\", [\"isMobile\"]),\n\t  labelWidth() {\n\t    return this.isMobile ? undefined : 90;\n\t  },\n\t  labelPosition() {\n\t    return this.isMobile ? \"top\" : \"right\";\n\t  },\n\t  labelBottom() {\n\t    return this.isMobile ? undefined : 15;\n\t  },\n\t},\n\tmounted(){\n\t\tthis.setCopyrightShow({ value: false });\n\t\tif(this.$route.params.id != 0){\n\t\t\tthis.getDiscountInfo();\n\t\t}\n\t},\n\tdestroyed () {\n\t  this.setCopyrightShow({ value: true });\n\t},\n\tmethods: {\n\t\t...mapMutations('admin/layout', [\n\t\t    'setCopyrightShow'\n\t\t]),\n\t\tdiscountTypeTap(item){\n\t\t\tthis.formValidate.n_piece_n_discount = item.id;\n\t\t\tif(item.id == 1){\n\t\t\t\tthis.formValidate.threshold = 2;\n\t\t\t\tthis.formValidate.discount = 50;\n\t\t\t}else if(item.id == 2){\n\t\t\t\tthis.formValidate.threshold = 2;\n\t\t\t\tthis.formValidate.discount = 0;\n\t\t\t}else{\n\t\t\t\tthis.formValidate.threshold = 1;\n\t\t\t\tthis.formValidate.discount = 100;\n\t\t\t}\n\t\t},\n\t\tgetDiscountInfo(){\n\t\t\tthis.formValidate.n_piece_n_discount = 0\n\t\t\tdiscountInfo(this.$route.params.id).then(res=>{\n\t\t\t\tthis.formValidate = res.data.info;\n\t\t\t\tthis.formValidate.discount = parseFloat(res.data.info.discount)\n\t\t\t\tthis.formValidate.threshold = parseFloat(res.data.info.threshold)\n\t\t\t\tthis.formValidate.is_overlay = this.formValidate.is_overlay.toString();\n\t\t\t\tthis.tableData = res.data.info.products\n\t\t\t\tthis.dataLabel = res.data.info.label_id;\n\t\t\t}).catch(err=>{\n\t\t\t\tthis.$Message.error(err.msg);\n\t\t\t})\n\t\t},\n\t\tdel(row){\n\t\t\tthis.tableData.forEach((i,index)=>{\n\t\t\t\tif(row.id == i.id){\n\t\t\t\t\t  return this.tableData.splice(index, 1)\n\t\t\t\t}else{\n\t\t\t\t\ti.attrValue.forEach((j,indexn)=>{\n\t\t\t\t\t\tif(row.id == j.id){\n\t\t\t\t\t\t\tif(i.attrValue.length == 1){\n\t\t\t\t\t\t\t\treturn this.tableData.splice(index, 1)\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\treturn i.attrValue.splice(indexn, 1)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\taddLabel(){\n\t\t\tthis.$modalForm(userLabelAddApi(0)).then(() => {});\n\t\t},\n\t\taddGoods(){\n\t\t\tthis.modals = true;\n\t\t},\n\t\tcancel () {\n\t\t    this.modals = false;\n\t\t},\n\t\t//对象数组去重；\n\t\tunique(arr) {\n\t\t    const res = new Map();\n\t\t    return arr.filter((arr) => !res.has(arr.id) && res.set(arr.id, 1))\n\t\t},\n\t\tgetProductId (data) {\n\t\t    this.modals = false;\n\t\t\t\tlet list = this.tableData.concat(data);\n\t\t\t\tlet uni = this.unique(list);\n\t\t\t\tuni.forEach((i)=>{\n\t\t\t\t\ti.attrValue.forEach(j=>{\n\t\t\t\t\t\tj.cate_name = i.cate_name;\n\t\t\t\t\t\tj.store_label = i.store_label;\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t\tthis.tableData = uni;\n\t\t},\n\t\t// 具体日期\n\t\tonchangeTime (e) {\n\t\t    this.formValidate.section_time = e;\n\t\t},\n\t\tcloseLabel(label){\n\t\t\tlet index = this.dataLabel.indexOf(this.dataLabel.filter(d=>d.id == label.id)[0]);\n\t\t\tthis.dataLabel.splice(index,1);\n\t\t},\n\t\tactiveData(dataLabel){\n\t\t\tthis.labelShow = false;\n\t\t\tthis.dataLabel = dataLabel;\n\t\t},\n\t\topenLabel(row) {\n\t\t  this.labelShow = true;\n\t\t\tthis.$refs.userLabel.userLabel(JSON.parse(JSON.stringify(this.dataLabel)));\n\t\t},\n\t\t// 标签弹窗关闭\n\t\tlabelClose() {\n\t\t  this.labelShow = false;\n\t\t},\n\t\t// 上一页：\n\t\tupTab() {\n\t\t\tif(this.currentTab==1&&this.formValidate.product_type!=0){\n\t\t\t\tthis.currentTab = (Number(this.currentTab) - 2).toString();\n\t\t\t}else{\n\t\t\t\tthis.currentTab = (Number(this.currentTab) - 1).toString();\n\t\t\t}\n\t\t},\n\t\t// 下一页；\n\t\tdownTab(name) {\n\t\t\tthis.$refs[name].validate((valid) => {\n\t\t\t\tif (valid) {\n\t\t\t\t\tif(!this.formValidate.threshold){\n\t\t\t\t\t\treturn this.$Message.warning(\"请填写优惠设置的件数\");\n\t\t\t\t\t}\n\t\t\t\t\tif(this.formValidate.discount == null){\n\t\t\t\t\t\treturn this.$Message.warning(\"请填写优惠设置的折扣\");\n\t\t\t\t\t}\n\t\t\t\t\tif(this.formValidate.is_label && !this.dataLabel.length){\n\t\t\t\t\t\treturn this.$Message.warning(\"请选择用户关联标签\");\n\t\t\t\t\t}\n\t\t\t\t\tif(parseInt(this.formValidate.is_overlay) && !this.formValidate.overlay.length){\n\t\t\t\t\t\treturn this.$Message.warning(\"请选择叠加的营销活动\");\n\t\t\t\t\t}\n\t\t\t\t\tif(this.formValidate.section_time[0] == ''){\n\t\t\t\t\t\treturn this.$Message.warning(\"请选择活动时间\");\n\t\t\t\t\t}\n\t\t\t\t\tthis.currentTab = '2'\n\t\t\t\t}else{\n\t\t\t\t\tthis.$Message.warning(\"请完善数据\");\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\thandleSubmit(name){\n\t\t\tthis.$refs[name].validate((valid) => {\n\t\t\t\tif (valid) {\n\t\t\t\t\tif(!this.formValidate.threshold){\n\t\t\t\t\t\treturn this.$Message.warning(\"请填写优惠设置\");\n\t\t\t\t\t}\n\t\t\t\t\tif(this.formValidate.is_label && !this.dataLabel.length){\n\t\t\t\t\t\treturn this.$Message.warning(\"请选择用户关联标签\");\n\t\t\t\t\t}\n\t\t\t\t\tif(parseInt(this.formValidate.is_overlay) && !this.formValidate.overlay.length){\n\t\t\t\t\t\treturn this.$Message.warning(\"请选择叠加的营销活动\");\n\t\t\t\t\t}\n\t\t\t\t\tif(this.formValidate.section_time[0] == ''){\n\t\t\t\t\t\treturn this.$Message.warning(\"请选择活动时间\");\n\t\t\t\t\t}\n\t\t\t\t\t// 用户标签\n\t\t\t\t\tlet activeIds = [];\n\t\t\t\t\tthis.dataLabel.forEach((item)=>{\n\t\t\t\t\t\tactiveIds.push(item.id)\n\t\t\t\t\t});\n\t\t\t\t\tif(this.formValidate.is_label==0){\n\t\t\t\t\t\tthis.formValidate.label_id = [];\n\t\t\t\t\t}else{\n\t\t\t\t\t\tthis.formValidate.label_id = activeIds\n\t\t\t\t\t}\n\t\t\t\t\tlet product_id = [];\n\t\t\t\t\tthis.tableData.forEach((item)=>{\n\t\t\t\t\t\t  let obj = {\n\t\t\t\t\t\t\t\t  product_id: item.id,\n\t\t\t\t\t\t\t\t\tunique:[]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif(item.attrValue.length){\n\t\t\t\t\t\t\t\titem.attrValue.forEach((j)=>{\n\t\t\t\t\t\t\t\t\tobj.unique.push(j.unique)\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tproduct_id.push(obj)\n\t\t\t\t\t})\n\t\t\t\t\tif(this.formValidate.product_partake_type !=1 && !product_id.length){\n\t\t\t\t\t\treturn this.$Message.error('请添加商品');\n\t\t\t\t\t}\n\t\t\t\t\tthis.formValidate.product_id = product_id\n\t\t\t\t\tsaveDiscount(2,this.$route.params.id,this.formValidate).then(res=>{\n\t\t\t\t\t\tthis.$router.push({ path: \"/admin/marketing/discount/pieces_discount\" });\n\t\t\t\t\t\tthis.$Message.success(res.msg)\n\t\t\t\t\t}).catch(err=>{\n\t\t\t\t\t\tthis.$Message.error(err.msg);\n\t\t\t\t\t})\n\t\t\t\t}else{\n\t\t\t\t\tthis.$Message.warning(\"请完善数据\");\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n}\n",null]}