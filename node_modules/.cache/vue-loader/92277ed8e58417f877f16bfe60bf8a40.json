{"remainingRequest":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js??ref--0-2!/home/darkcrossunicorn/文档/admin/src/pages/marketing/lottery/create.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/darkcrossunicorn/文档/admin/src/pages/marketing/lottery/create.vue","mtime":1658975056000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js","mtime":1570440814000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { mapMutations, mapState } from \"vuex\";\nimport goodsList from \"@/components/goodsList/index\";\nimport uploadPictures from \"@/components/uploadPictures\";\nimport userLabel from \"@/components/labelList\";\nimport addGoods from \"./addGoods\";\nimport {\n  lotteryDetailApi,\n  lotteryCreateApi,\n  lotteryEditApi,\n  lotteryFactorInfo,\n} from \"@/api/lottery\"; //详情 创建 编辑\nimport { lotteryFrom } from \"./formRule/lotteryFrom\";\nimport { labelListApi } from \"@/api/product\";\nimport { levelListApi } from \"@/api/user\";\nimport WangEditor from \"@/components/wangEditor/index.vue\";\nimport { formatDate } from \"@/utils/validate\";\nimport { formatRichText } from \"@/utils/editorImg\";\n\nexport default {\n  name: \"lotteryCreate\",\n  components: { goodsList, uploadPictures, WangEditor, addGoods, userLabel },\n  data() {\n    return {\n\t\t\tdataLabel:[],\n\t\t\tlabelShow:false,\n      headTab: [\n        {\n          name: \"积分抽取\",\n          type: \"1\",\n        },\n        {\n          name: \"订单支付\",\n          type: \"3\",\n        },\n        {\n          name: \"订单评价\",\n          type: \"4\",\n        },\n        {\n          name: \"关注公众号\",\n          type: \"5\",\n        },\n      ],\n      title: \"添加商品\",\n      loading: false,\n      userLabelList: [], //用户标签列表\n      userLevelListApi: [], //用户等级列表\n      submitOpen: false,\n      spinShow: false,\n      addGoodsModel: false,\n      editData: {},\n      myConfig: {\n        autoHeightEnabled: false, // 编辑器不自动被内容撑高\n        initialFrameHeight: 500, // 初始容器高度\n        initialFrameWidth: \"100%\", // 初始容器宽度\n        UEDITOR_HOME_URL: \"/admin/UEditor/\",\n        serverUrl: \"\",\n      },\n      isChoice: \"单选\",\n      modalPic: false,\n      modal_loading: false,\n      images: [],\n      templateList: [\n        { id: 0, name: \"非付费会员\" },\n        { id: 1, name: \"付费会员\" },\n      ],\n      columns: [\n        {\n          title: \"序号\",\n          type: \"index\",\n          width: 60,\n          align: \"center\",\n        },\n        {\n          title: \"图片\",\n          slot: \"image\",\n          align: \"center\",\n          minWidth: 120,\n        },\n        {\n          title: \"名称\",\n          align: \"center\",\n          minWidth: 80,\n          key: \"name\",\n        },\n        {\n          title: \"奖品\",\n          slot: \"type\",\n          align: \"center\",\n          minWidth: 80,\n        },\n        {\n          title: \"提示语\",\n          key: \"prompt\",\n          align: \"center\",\n          minWidth: 80,\n        },\n        {\n          title: \"数量\",\n          slot: \"total\",\n          align: \"center\",\n          minWidth: 80,\n        },\n        {\n          title: \"奖品权重\",\n          slot: \"chance\",\n          align: \"center\",\n          minWidth: 80,\n        },\n        {\n          title: \"奖品概率\",\n          key: \"probability\",\n          align: \"center\",\n          minWidth: 80,\n        },\n        {\n          title: \"操作\",\n          slot: \"setting\",\n          align: \"center\",\n          minWidth: 80,\n        },\n      ],\n      specsData: [],\n      formValidate: {\n        images: [],\n        name: \"\", //活动名称\n        desc: \"\", //活动描述\n        image: \"\", //活动背景图\n        factor: \"1\", //抽奖类型：1:积分 2:余额 3：下单支付成功 4:订单评价',5:关注\n        factor_num: 1, //获取一次抽奖的条件数量\n        attends_user: 1, //参与用户1：所有  2：部分\n        user_level: 0, //参与用户等级\n        user_label: [], //参与用户标签\n        is_svip: \"-1\", //参与用户是否付费会员\n        prize_num: 0, //奖品数量\n        period: [], //活动时间\n        prize: [], //奖品数组\n        lottery_num_term: 1, //抽奖次数限制：1：每天2：每人\n        lottery_num: 1, //抽奖次数\n        spread_num: 1, //关注推广获取抽奖次数\n        is_all_record: 0, //中奖纪录展示\n        is_personal_record: 0, //个人中奖纪录展示\n        is_content: 0, //活动规格是否展示\n        content: \"\", //富文本内容\n        status: 0, //状态\n      },\n      ruleValidate: lotteryFrom,\n      currentid: \"\",\n      picTit: \"\",\n      tableIndex: 0,\n      copy: 0,\n      editIndex: null,\n      id: \"\",\n      isData: 0,\n      content: \"\",\n    };\n  },\n  filters: {\n    typeName(type) {\n      if (type == 1) {\n        return \"未中奖\";\n      } else if (type == 2) {\n        return \"积分\";\n      } else if (type == 3) {\n        return \"余额\";\n      } else if (type == 4) {\n        return \"红包\";\n      } else if (type == 5) {\n        return \"优惠券\";\n      } else if (type == 6) {\n        return \"商品\";\n      }\n    },\n  },\n  computed: {\n    ...mapState(\"admin/layout\", [\"isMobile\",\"menuCollapse\"]),\n    labelWidth() {\n      return this.isMobile ? undefined : 135;\n    },\n    labelPosition() {\n      return this.isMobile ? \"top\" : \"right\";\n    },\n  },\n  mounted() {\n    // if (this.$route.query.id) {\n    //   this.id = this.$route.query.id;\n    //   this.copy = this.$route.query.copy || 0;\n    // }\n    this.prizeList();\n    this.getInfo();\n    this.labelListApi();\n    this.levelListApi();\n    this.setCopyrightShow({ value: false });\n  },\n  destroyed() {\n    this.setCopyrightShow({ value: true });\n  },\n  methods: {\n    ...mapMutations(\"admin/layout\", [\"setCopyrightShow\"]),\n    prizeList() {\n      let list = [];\n      let data = {\n        type: 1, //类型 1：未中奖2：积分  3:余额  4：红包 5:优惠券 6：站内商品\n        name: \"\", //活动名称\n        num: 0, //奖品数量\n        image: \"\", //奖品图片\n        chance: 1, //中奖权重\n        total: 0, //奖品数量\n        prompt: \"\", //提示语\n      };\n      for (var i = 0; i < 8; i++) {\n        list.push(data);\n      }\n      this.specsData = JSON.parse(JSON.stringify(list));\n    },\n    getEditorContent(data) {\n      this.content = data;\n    },\n\t\tcloseLabel(label){\n\t\t\tlet index = this.dataLabel.indexOf(this.dataLabel.filter(d=>d.id == label.id)[0]);\n\t\t\tthis.dataLabel.splice(index,1);\n\t\t},\n\t\tactiveData(dataLabel){\n\t\t\tthis.labelShow = false;\n\t\t\tthis.dataLabel = dataLabel;\n\t\t},\n\t\topenLabel(row) {\n\t\t  this.labelShow = true;\n\t\t\tthis.$refs.userLabel.userLabel(JSON.parse(JSON.stringify(this.dataLabel)));\n\t\t},\n\t\t// 标签弹窗关闭\n\t\tlabelClose() {\n\t\t  this.labelShow = false;\n\t\t},\n    //用户标签列表\n    labelListApi() {\n      labelListApi().then((res) => {\n        this.userLabelList = res.data.list;\n      });\n    },\n    //用户等级列表\n    levelListApi() {\n      levelListApi().then((res) => {\n        this.userLevelListApi = res.data.list;\n      });\n    },\n    // 具体日期\n    onchangeTime(e) {\n      this.$nextTick(() => {\n        this.$set(this.formValidate, \"period\", e);\n      });\n    },\n    lotteryType() {\n      this.getInfo();\n    },\n    // 详情\n    getInfo() {\n      this.spinShow = true;\n      lotteryFactorInfo(this.formValidate.factor).then((res) => {\n        let factor = this.formValidate.factor;\n        this.spinShow = false;\n        this.isData = res.data.id || 0;\n        if (!this.isData) {\n          this.prizeList();\n          this.formValidate = {\n            factor: factor,\n            images: [],\n            name: \"\", //活动名称\n            desc: \"\", //活动描述\n            image: \"\", //活动背景图\n            factor_num: 1, //获取一次抽奖的条件数量\n            attends_user: 1, //参与用户1：所有  2：部分\n            user_level: 0, //参与用户等级\n            user_label: [], //参与用户标签\n            is_svip: \"-1\", //参与用户是否付费会员\n            prize_num: 0, //奖品数量\n            period: [], //活动时间\n            prize: [], //奖品数组\n            lottery_num_term: 1, //抽奖次数限制：1：每天2：每人\n            lottery_num: 1, //抽奖次数\n            spread_num: 1, //关注推广获取抽奖次数\n            is_all_record: 0, //中奖纪录展示\n            is_personal_record: 0, //个人中奖纪录展示\n            is_content: 0, //活动规格是否展示\n            content: \"\", //富文本内容\n            status: 0, //状态\n          };\n          return;\n        }\n        this.formValidate = res.data;\n        this.formValidate.factor = res.data.factor.toString();\n        this.formValidate.user_level = res.data.user_level || [];\n        this.formValidate.user_label = res.data.user_label || [];\n\t\t\t\tthis.dataLabel = res.data.user_label || [];\n        this.formValidate.is_svip = res.data.is_svip;\n        this.content = res.data.is_content ? res.data.content : \"\";\n        this.formValidate.period = [\n          this.formatDate(res.data.start_time) || \"\",\n          this.formatDate(res.data.end_time) || \"\",\n        ];\n        this.specsData = res.data.prize;\n        this.getProbability();\n      });\n    },\n    // 下一步\n    next(name) {\n      this.formValidate.prize = this.specsData;\n      if (this.formValidate.is_content) {\n        this.formValidate.content = formatRichText(this.content);\n      }\n      if (this.submitOpen) return false;\n      this.$refs[name].validate((valid) => {\n        if (valid) {\n          if (this.formValidate.period[0] == \"\") {\n            return this.$Message.error(\"请选择日期\");\n          }\n          this.submitOpen = true;\n\t\t\t\t\t// 用户标签\n\t\t\t\t\tlet activeIds = [];\n\t\t\t\t\tthis.dataLabel.forEach((item)=>{\n\t\t\t\t\t\tactiveIds.push(item.id)\n\t\t\t\t\t});\n\t\t\t\t\tthis.formValidate.user_label = activeIds\n          if (this.isData) {\n            lotteryEditApi(this.isData, this.formValidate)\n              .then(async (res) => {\n                this.$Message.success(res.msg);\n                setTimeout(() => {\n                  this.submitOpen = false;\n                  // this.$router.push({\n                  //   path: \"/admin/marketing/lottery/index\",\n                  // });\n                }, 500);\n              })\n              .catch((res) => {\n                this.submitOpen = false;\n                this.$Message.error(res.msg);\n              });\n          } else {\n            lotteryCreateApi(this.formValidate)\n              .then(async (res) => {\n                this.$Message.success(res.msg);\n                setTimeout(() => {\n                  this.submitOpen = false;\n                  // this.$router.push({\n                  //   path: \"/admin/marketing/lottery/index\",\n                  // });\n                }, 500);\n              })\n              .catch((res) => {\n                this.submitOpen = false;\n                this.$Message.error(res.msg);\n              });\n          }\n        } else {\n          return this.$Message.error(\"请完善信息\");\n        }\n      });\n    },\n    // 上一步\n    step() {\n      this.current--;\n    },\n    // 内容\n    getContent(val) {\n      this.formValidate.content = val;\n    },\n    // 规则\n    getRole(val) {\n      this.formValidate.rule = val;\n    },\n    // 点击商品图\n    modalPicTap(tit, picTit, index) {\n      this.modalPic = true;\n      this.isChoice = tit === \"dan\" ? \"单选\" : \"多选\";\n      this.picTit = picTit || \"\";\n      this.tableIndex = index;\n    },\n    // 获取单张图片信息\n    getPic(pc) {\n      switch (this.picTit) {\n        case \"danFrom\":\n          this.formValidate.image = pc.att_dir;\n          break;\n        default:\n          this.specsData[this.tableIndex].image = pc.att_dir;\n      }\n      this.modalPic = false;\n    },\n    handleRemove() {\n      this.formValidate.image = \"\";\n    },\n    // 表单验证\n    // validate(prop, status, error) {\n    //   if (status === false) {\n    //     this.$Message.error(error);\n    //     return false;\n    //   } else {\n    //     return true;\n    //   }\n    // },\n    // 添加自定义弹窗\n    addCustomDialog(editorId) {\n      window.UE.registerUI(\n        \"test-dialog\",\n        function (editor, uiName) {\n          // 创建 dialog\n          let dialog = new window.UE.ui.Dialog({\n            // 指定弹出层中页面的路径，这里只能支持页面，路径参考常见问题 2\n            iframeUrl: \"/admin/widget.images/index.html?fodder=dialog\",\n            // 需要指定当前的编辑器实例\n            editor: editor,\n            // 指定 dialog 的名字\n            name: uiName,\n            // dialog 的标题\n            title: \"上传图片\",\n            // 指定 dialog 的外围样式\n            cssRules: \"width:1200px;height:500px;padding:20px;\",\n          });\n          this.dialog = dialog;\n          var btn = new window.UE.ui.Button({\n            name: \"dialog-button\",\n            title: \"上传图片\",\n            cssRules: `background-image: url(../../../assets/images/icons.png);background-position: -726px -77px;`,\n            onclick: function () {\n              // 渲染dialog\n              dialog.render();\n              dialog.open();\n            },\n          });\n          return btn;\n        },\n        37\n      );\n    },\n    //新增商品\n    addGoods() {\n      this.addGoodsModel = true;\n      this.title = \"添加商品\";\n      this.editData = {};\n    },\n    //编辑商品\n    editGoods(index) {\n      this.addGoodsModel = true;\n      this.title = \"编辑奖品\";\n      this.editData = this.specsData[index];\n      this.editIndex = index;\n    },\n    //删除商品\n    deleteGoods(index) {\n      this.specsData.splice(index, 1);\n    },\n    //获取数组中某个字段之和\n    sumArr(arr, name) {\n      let arrData = [];\n      for (let i = 0; i < arr.length; i++) {\n        arrData.push(arr[i][name]);\n      }\n      return eval(arrData.join(\"+\"));\n    },\n    addGoodsData(data) {\n      this.editIndex != null\n        ? this.$set(this.specsData, [this.editIndex], data)\n        : this.specsData.length < 8\n        ? this.specsData.push(data)\n        : this.$Message.warning(\"最多添加8个奖品\");\n      this.getProbability();\n      this.addGoodsModel = false;\n      this.editIndex = null;\n    },\n    changeChance(data, index) {\n      this.$set(this.specsData[index], \"chance\", data);\n      this.$nextTick((e) => {\n        this.getProbability();\n      });\n    },\n    changeTotal(data, index) {\n      this.$set(this.specsData[index], \"total\", data);\n    },\n    //获取商品中奖概率\n    getProbability() {\n      let sum = 0;\n      sum = this.sumArr(this.specsData, \"chance\");\n      for (let j = 0; j < this.specsData.length; j++) {\n        this.$set(\n          this.specsData[j],\n          \"probability\",\n          ((this.specsData[j].chance / sum) * 100).toFixed(2) + \"%\"\n        );\n      }\n    },\n    //修改排序\n    onDragDrop(a, b) {\n      this.specsData.splice(\n        b,\n        1,\n        ...this.specsData.splice(a, 1, this.specsData[b])\n      );\n    },\n    //时间格式转换\n    formatDate(time) {\n      if (time) {\n        let date = new Date(time * 1000);\n        return formatDate(date, \"yyyy-MM-dd hh:mm\");\n      } else {\n        return \"\";\n      }\n    },\n  },\n};\n",null]}