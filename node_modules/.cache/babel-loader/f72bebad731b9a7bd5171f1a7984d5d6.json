{"remainingRequest":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js!/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js??ref--0-0!/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js??ref--0-2!/home/darkcrossunicorn/文档/admin/src/pages/kefu/appChat/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/darkcrossunicorn/文档/admin/src/pages/kefu/appChat/index.vue","mtime":1664771259578},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js","mtime":1570440814000}],"contextDependencies":[],"result":["function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }\n\nfunction _nonIterableSpread() { throw new TypeError(\"Invalid attempt to spread non-iterable instance\"); }\n\nfunction _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter); }\n\nfunction _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport \"emoji-awesome/dist/css/google.min.css\";\nimport emojiList from \"@/utils/emoji\";\nimport { Socket } from \"@/libs/socket\";\nimport Setting from \"@/setting\";\nimport Cookies from \"js-cookie\";\nimport { chatListApi, serviceListApi, getAdvApi } from \"@/api/kefu\";\nimport feedBack from \"./feedback\";\n\nvar chunk = function chunk(arr, num) {\n  num = num * 1 || 1;\n  var ret = [];\n  arr.forEach(function (item, i) {\n    if (i % num === 0) {\n      ret.push([]);\n    }\n\n    ret[ret.length - 1].push(item);\n  });\n  return ret;\n};\n\nexport default {\n  name: \"ChatRoom\",\n  auth: false,\n  components: {\n    feedBack: feedBack\n  },\n  props: {\n    chatOptions: {\n      type: Object,\n      default: function _default() {\n        return {\n          show: false\n        };\n      }\n    }\n  },\n  directives: {\n    drag: {\n      inserted: function inserted(el) {\n        var x = 0;\n        var y = 0;\n        var l = 0;\n        var t = 0;\n        var isDown = false;\n\n        el.onmousedown = function (e) {\n          x = e.clientX;\n          y = e.clientY;\n          l = el.parentNode.offsetLeft;\n          t = el.parentNode.offsetTop;\n          isDown = true;\n          el.style.cursor = \"move\";\n\n          window.onmousemove = function (e) {\n            if (isDown == false) {\n              return;\n            }\n\n            var nx = e.clientX;\n            var ny = e.clientY;\n            var nl = nx - (x - l);\n            var nt = ny - (y - t);\n            el.parentNode.style.left = nl + \"px\";\n            el.parentNode.style.top = nt + \"px\";\n          };\n\n          window.onmouseup = function () {\n            isDown = false;\n            el.style.cursor = \"default\";\n            window.onmousemove = null;\n            window.onmouseup = null;\n          };\n\n          return false;\n        };\n      }\n    }\n  },\n  data: function data() {\n    return {\n      locations: \"\".concat(location.origin),\n      change: false,\n      emojiGroup: chunk(emojiList, 20),\n      // 表情列表\n      emojiList: emojiList,\n      emojiShow: false,\n      recordList: [],\n      limit: 20,\n      loading: false,\n      finished: false,\n      chatCont: \"\",\n      service: null,\n      serviceData: {},\n      uploadAction: \"\",\n      notice: \"\",\n      audio: null,\n      muted: false,\n      audioSrc: \"\",\n      upperId: 0,\n      uploadData: {},\n      is_tourist: 1,\n      // 0登录状态，1未登录状态游客\n      text: \"\",\n      isLoad: false,\n      page: 1,\n      tourist_avatar: \"\",\n      // 游客头像\n      tourist_uid: \"\",\n      // 游客id\n      toUid: \"\",\n      // 客服id\n      kufuToken: \"\",\n      // token\n      pageWs: \"\"\n    };\n  },\n  watch: {\n    muted: function muted(value) {\n      this.audio.muted = value;\n    }\n  },\n  computed: {\n    records: function records() {\n      var _this = this;\n\n      return this.recordList.map(function (item, index) {\n        if (index) {\n          if (new Date(item.add_time) - new Date(_this.recordList[index - 1].add_time) >= 300000) {\n            item.show = true;\n          } else {\n            item.show = false;\n          }\n        } else {\n          item.show = false;\n        }\n\n        return item;\n      });\n    }\n  },\n  created: function created() {\n    if (location.href.indexOf(\"kefu\") != -1) this.uploadAction = Setting.apiBaseURL.replace(/adminapi/, \"kefuapi\") + \"/tourist/upload\";\n    var token = Cookies.get(\"auth._token.local1\");\n    this.kufuToken = token ? token.split(\"Bearer%20\")[1] : \"\";\n  },\n  mounted: function mounted() {\n    var that = this;\n    window.addEventListener(\"click\", function () {\n      if (that.emojiShow) {\n        that.emojiShow = false;\n      }\n    });\n    if (this.$wechat._isMobile()) this.$router.replace(\"/kefu/mobile_user_chat\");\n    this.getService();\n    this.pageWs = Socket(true, this.kufuToken, this.tourist_uid);\n    this.text = this.replace_em(\"[em-smiling_imp]\");\n    this.wsStart();\n  },\n  beforeDestroy: function beforeDestroy() {\n    this.pageWs.close();\n  },\n  methods: {\n    wsStart: function wsStart() {\n      var _this2 = this;\n\n      var that = this;\n      this.pageWs.then(function (ws) {\n        if (_this2.kufuToken) {\n          ws.send({\n            type: \"login\",\n            data: _this2.kufuToken\n          });\n        }\n\n        _this2.getService();\n\n        ws.$on([\"reply\", \"chat\"], function (data) {\n          if (data.msn_type == 1) {\n            data.msn = _this2.replace_em(data.msn);\n          }\n\n          _this2.recordList.push(data);\n\n          setTimeout(function (res) {\n            _this2.$nextTick(function () {\n              this.$refs.record.scrollTop = this.$refs.record.scrollHeight - this.$refs.record.clientHeight;\n            });\n          }, 300);\n        }); // 监听客服转接\n\n        ws.$on(\"to_transfer\", function (data) {\n          _this2.toUid = data.toUid;\n          ws.send({\n            data: {\n              id: _this2.toUid\n            },\n            type: \"to_chat\"\n          });\n        });\n        ws.$on(\"socket_error\", function () {\n          _this2.$Message.error(\"连接失败\");\n        });\n        ws.$on(\"err_tip\", function (data) {\n          _this2.$Message.error(data.msg);\n        });\n        ws.$on(\"success\", function (data) {\n          _this2.is_tourist = 0;\n        });\n        ws.$on(\"timeout\", function (data) {\n          setTimeout(function () {\n            _this2.wsRestart();\n          }, 2000);\n        });\n      }).catch(function (error) {\n        setTimeout(function (res) {\n          _this2.wsRestart();\n        }, 2000);\n      });\n    },\n    wsRestart: function wsRestart() {\n      this.pageWs = Socket(true, this.kufuToken, this.tourist_uid);\n      this.wsStart();\n    },\n    onLook: function onLook(id) {\n      window.open(\"\".concat(location.origin, \"/home/goods_detail/\").concat(id));\n    },\n    // 关闭\n    closeChange: function closeChange(msg) {\n      this.change = msg;\n    },\n    // 统一发送处理\n    sendMsg: function sendMsg(msn, type) {\n      var obj = {\n        type: \"chat\",\n        data: {\n          msn: msn,\n          type: type,\n          is_tourist: this.is_tourist,\n          to_uid: this.toUid,\n          tourist_uid: this.tourist_uid,\n          tourist_avatar: this.tourist_avatar,\n          form_type: this.$wechat.isWeixin() ? 1 : 3\n        }\n      };\n      this.pageWs.then(function (ws) {\n        ws.send(obj);\n      });\n    },\n    // 随机客服\n    getService: function getService() {\n      var _this3 = this;\n\n      serviceListApi({\n        token: this.kufuToken || \"\"\n      }).then(function (res) {\n        _this3.serviceData = res.data;\n        _this3.upperId = 0;\n        _this3.toUid = res.data.uid;\n        _this3.tourist_uid = res.data.tourist_uid;\n        _this3.tourist_avatar = res.data.tourist_avatar;\n        var obj = {\n          data: {\n            id: res.data.uid,\n            tourist_uid: _this3.tourist_uid\n          },\n          type: \"to_chat\"\n        };\n\n        _this3.pageWs.then(function (ws) {\n          ws.send(obj);\n        });\n\n        if (_this3.kufuToken) {\n          _this3.getRecordList();\n        }\n      }).catch(function (err) {\n        // this.$Message.error(err.msg);\n        _this3.change = true;\n      });\n    },\n    roomClick: function roomClick(event) {// if (\n      //     !event.target.classList.contains(\"emoji-panel\") &&\n      //     !event.target.classList.contains(\"emoji-btn\") &&\n      //     !event.target.classList.contains(\"icon-biaoqing\") &&\n      //     this.emojiShow\n      // ) {\n      //     this.emojiShow = false;\n      // }\n    },\n    // enter 发送\n    ctrlEnter: function ctrlEnter(e) {\n      if (e.keyCode == 13) {\n        e.preventDefault();\n      }\n\n      if (this.chatCont.trim()) {\n        this.sendMessage();\n      }\n    },\n    // 关闭聊天窗口\n    close: function close() {\n      this.$emit(\"chat-close\");\n    },\n    // 选择表情\n    selectEmoji: function selectEmoji(data) {\n      var val = \"[\".concat(data, \"]\");\n      this.chatCont += val;\n      this.emojiShow = false;\n    },\n    // 聊天表情转换\n    replace_em: function replace_em(str) {\n      str = str.replace(/\\[em-([\\s\\S]*)\\]/g, \"<span class='em em-$1'/></span>\");\n      return str;\n    },\n    onScroll: function onScroll(event) {\n      if (event.target.scrollTop <= 30) {\n        if (this.kufuToken) {\n          this.getRecordList();\n        }\n      }\n    },\n    // 聊天记录\n    getRecordList: function getRecordList() {\n      var _this4 = this;\n\n      if (this.loading) {\n        return;\n      }\n\n      if (this.finished) {\n        return;\n      }\n\n      this.loading = true;\n      chatListApi({\n        uid: this.serviceData.uid,\n        limit: this.limit,\n        upperId: this.upperId,\n        token: this.kufuToken\n      }).then(function (res) {\n        if (res.data.length === 0) return _this4.loading = false;\n        res.data.forEach(function (el) {\n          if (el.msn_type == 1) {\n            el.msn = _this4.replace_em(el.msn);\n          }\n        });\n        var selector = \"\";\n\n        if (_this4.upperId == 0) {\n          selector = \"chat_\".concat(res.data[res.data.length - 1].id);\n        } else {\n          selector = \"chat_\".concat(_this4.recordList[0].id);\n        }\n\n        _this4.recordList = [].concat(_toConsumableArray(res.data), _toConsumableArray(_this4.recordList));\n        _this4.upperId = res.data.length > 0 ? res.data[0].id : 0;\n        _this4.loading = false;\n        _this4.finished = res.data.length < _this4.limit;\n\n        _this4.$nextTick(function () {\n          this.setPageScrollTo(selector);\n        });\n      }).catch(function (err) {\n        _this4.$Message.error(err.msg);\n      });\n    },\n    // 设置页面滚动位置\n    setPageScrollTo: function setPageScrollTo(selector) {\n      var _this5 = this;\n\n      this.$nextTick(function () {\n        if (selector) {\n          setTimeout(function () {\n            var num = parseFloat(document.getElementById(selector).offsetTop) - 60;\n            _this5.$refs.record.scrollTop = num;\n          }, 0);\n        } else {\n          var container = document.querySelector(\"#chat_scroll\");\n          _this5.$refs.record.scrollTop = container.offsetHeight;\n          setTimeout(function (res) {\n            if (_this5.$refs.record.scrollTop != _this5.$refs.scrollBox.offsetHeight) {\n              _this5.$refs.record.scrollTop = document.querySelector(\"#chat_scroll\").offsetHeight;\n            }\n          }, 300);\n        }\n      });\n    },\n    // 表情包显示隐藏\n    emojiSwitch: function emojiSwitch() {\n      this.emojiShow = true;\n    },\n    // 发送消息\n    sendMessage: function sendMessage() {\n      this.sendMsg(this.chatCont, 1);\n      this.chatCont = \"\";\n    },\n    chat: function chat(data) {\n      var _this6 = this;\n\n      if (data.uid != this.$auth.user.uid && this.audio) {\n        this.audio.play();\n      }\n\n      this.recordList.push(data);\n      this.$nextTick(function () {\n        _this6.$refs.record.scrollTop = _this6.$refs.record.scrollHeight - _this6.$refs.record.clientHeight;\n      });\n    },\n    sendGoods: function sendGoods() {\n      var _this7 = this;\n\n      if (this.chatOptions.goodsId) {\n        this.pageWs.then(function (ws) {\n          ws.send({\n            data: {\n              msn: _this7.chatOptions.goodsId,\n              type: 5,\n              to_uid: _this7.toUid\n            },\n            type: \"to_chat\"\n          });\n        });\n      }\n    },\n    sendOrder: function sendOrder() {\n      var _this8 = this;\n\n      if (this.chatOptions.orderId) {\n        this.pageWs.then(function (ws) {\n          ws.send({\n            data: {\n              msn: _this8.chatOptions.orderId,\n              type: 6,\n              to_uid: _this8.toUid\n            },\n            type: \"to_chat\"\n          });\n        });\n      }\n    },\n    chatEnd: function chatEnd() {\n      if (navigator.userAgent.indexOf(\"MSIE\") > 0) {\n        if (navigator.userAgent.indexOf(\"MSIE 6.0\") > 0) {\n          window.opener = null;\n          window.close();\n        } else {\n          window.open(\"\", \"_top\");\n          window.top.close();\n        }\n      } else if (navigator.userAgent.indexOf(\"Firefox\") > 0) {\n        window.location.href = \"about:blank \";\n      } else {\n        window.opener = null;\n        window.open(\"\", \"_self\", \"\");\n        window.close();\n      }\n    },\n    // 广告\n    getNotice: function getNotice() {\n      var _this9 = this;\n\n      getAdvApi().then(function (res) {\n        _this9.notice = res.data.content;\n      });\n    },\n    beforeUpload: function beforeUpload(file) {\n      var _this10 = this;\n\n      this.uploadData = {\n        filename: file,\n        token: this.kufuToken\n      };\n      var promise = new Promise(function (resolve) {\n        _this10.$nextTick(function () {\n          resolve(true);\n        });\n      });\n      return promise;\n    },\n    handleFormatError: function handleFormatError(file) {\n      this.$Message.error(\"上传图片只能是 jpg、jpg、jpeg、gif 格式!\");\n    },\n    uploadSuccess: function uploadSuccess(res) {\n      this.sendMsg(res.data.url, 3);\n    },\n    uploadError: function uploadError(error) {\n      this.$message.error(error);\n    }\n  }\n};",null]}