{"remainingRequest":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js!/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js??ref--0-0!/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js??ref--0-2!/home/darkcrossunicorn/文档/admin/src/pages/kefu/appChat/mobile/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/darkcrossunicorn/文档/admin/src/pages/kefu/appChat/mobile/index.vue","mtime":1661152956000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000},{"path":"/home/darkcrossunicorn/文档/admin/node_modules/iview-loader/index.js","mtime":1570440814000}],"contextDependencies":[],"result":["function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }\n\nfunction _nonIterableSpread() { throw new TypeError(\"Invalid attempt to spread non-iterable instance\"); }\n\nfunction _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter); }\n\nfunction _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport Setting from '@/setting';\nimport { Socket } from '@/libs/socket';\nimport util from '@/libs/util';\nimport emojiList from '@/utils/emoji';\nimport { serviceListApi, getOrderApi, chatListApi, productApi } from '@/api/kefu';\n\nvar chunk = function chunk(arr, num) {\n  num = num * 1 || 1;\n  var ret = [];\n  arr.forEach(function (item, i) {\n    if (i % num === 0) {\n      ret.push([]);\n    }\n\n    ret[ret.length - 1].push(item);\n  });\n  return ret;\n};\n\nexport default {\n  name: 'chat_mobile',\n  data: function data() {\n    return {\n      ops: {\n        vuescroll: {\n          mode: 'slide',\n          enable: false,\n          auto: false,\n          autoLoadDistance: 0,\n          pullRefresh: {\n            enable: true,\n            auto: false,\n            autoLoadDistance: 0,\n            tips: {\n              deactive: '',\n              active: '上拉加载更多',\n              start: 'Loading...',\n              beforeDeactive: ' '\n            }\n          },\n          pushLoad: {\n            enable: false\n          }\n        },\n        bar: {\n          background: '#393232',\n          opacity: '.5',\n          size: '2px'\n        }\n      },\n      swiperOptions: {},\n      status: false,\n      loading: false,\n      isTool: false,\n      isSwiper: false,\n      isWords: false,\n      autoplay: false,\n      circular: true,\n      interval: 3000,\n      duration: 500,\n      emojiGroup: chunk(emojiList, 21),\n      con: '',\n      toUid: '',\n      limit: 15,\n      upperId: 0,\n      chatList: [],\n      kefuInfo: {},\n      scrollTop: 0,\n      active: true,\n      isScroll: true,\n      oldHeight: 0,\n      selector: '',\n      transferList: [],\n      // 转接列表\n      isTransfer: false,\n      uploadData: {},\n      // 上传参数\n      header: {},\n      fileUrl: '',\n      userToken: '',\n      tourist_uid: '',\n      // 游客的uid\n      orderId: '',\n      orderInfo: '',\n      cartInfo: '',\n      productId: '',\n      productInfo: '',\n      tourist_avatar: '',\n      pageWs: ''\n    };\n  },\n  computed: {\n    isSend: function isSend() {\n      if (this.con.length == 0) {\n        return false;\n      } else {\n        return true;\n      }\n    },\n    records: function records() {\n      var _this = this;\n\n      return this.chatList.map(function (item, index) {\n        item.time = _this.$moment(item.add_time * 1000).format('MMMDo h:mm');\n\n        if (index) {\n          if (item.add_time - _this.chatList[index - 1].add_time >= 300) {\n            item.show = true;\n          } else {\n            item.show = false;\n          }\n        } else {\n          item.show = true;\n        }\n\n        return item;\n      });\n    }\n  },\n  created: function created() {\n    var token = localStorage.getItem('LOGIN_STATUS_TOKEN') || '';\n    this.fileUrl = Setting.apiBaseURL.replace('adminapi', 'kefuapi') + '/tourist/upload';\n    this.userToken = token;\n    this.toUid = this.$route.query.toUid || '';\n    this.nickname = this.$route.query.nickname || '';\n    this.orderId = this.$route.query.orderId || '';\n    this.productId = this.$route.query.product_id || '';\n  },\n  mounted: function mounted() {\n    var _this2 = this;\n\n    if (!this.$wechat._isMobile()) this.$router.replace('/kefu/appChat');\n    var that = this;\n    this.getServiceList();\n\n    if (this.userToken) {\n      this.getOrderInfo();\n      this.getGoodsInfo();\n    } // 上传头部token\n\n\n    this.header['Authori-zation'] = 'Bearer ' + this.userToken;\n    this.pageWs = Socket(true);\n    this.$nextTick(function () {\n      _this2.wsStart();\n    });\n  },\n  methods: {\n    goBack: function goBack() {\n      this.$router.go(-1);\n    },\n    wsStart: function wsStart() {\n      var _this3 = this;\n\n      var that = this;\n      this.pageWs.then(function (ws) {\n        if (_this3.userToken) {\n          ws.send({\n            type: 'login',\n            data: _this3.userToken\n          });\n        } // 消息接收\n\n\n        ws.$on(['reply', 'chat'], function (data) {\n          if (data.msn_type == 1 || data.msn_type == 2) {\n            data.msn = _this3.replace_em(data.msn);\n          }\n\n          _this3.chatList.push(data);\n\n          _this3.$nextTick(function () {\n            _this3.$refs['scrollBox'].refresh();\n\n            _this3.scrollBom();\n          });\n\n          setTimeout(function (res) {\n            _this3.$refs['scrollBox'].refresh();\n          }, 300);\n        });\n        ws.$on('socket_error', function () {\n          _this3.$Message.error('连接失败');\n        });\n        ws.$on('error', function () {\n          _this3.$Message.error('连接失败');\n        });\n        ws.$on('to_transfer', function (data) {\n          ws.send({\n            data: {\n              id: data.toUid\n            },\n            type: 'to_chat'\n          });\n        });\n        ws.$on('online', function (data) {\n          if (data.online == 0 && data.uid == that.toUid) {\n            that.$Modal.confirm({\n              title: '提示',\n              content: '客服已离线，是否需要反馈？',\n              okText: '确定',\n              cancelText: '取消',\n              onOk: function onOk() {\n                that.$router.replace({\n                  path: '/kefu/mobile_feedback'\n                });\n              }\n            });\n          }\n        });\n        ws.$on('timeout', function (data) {\n          setTimeout(function () {\n            _this3.wsRestart();\n          }, 2000);\n        });\n      }).catch(function (error) {\n        setTimeout(function (res) {\n          _this3.wsRestart();\n        }, 2000);\n      });\n    },\n    wsRestart: function wsRestart() {\n      this.pageWs = Socket(true);\n      this.wsStart();\n    },\n    handleFormatError: function handleFormatError(file) {\n      this.$Message.error('上传图片只能是 jpg、jpg、jpeg、gif 格式!');\n    },\n    // 获取商品信息\n    getGoodsInfo: function getGoodsInfo() {\n      var _this4 = this;\n\n      if (!this.productId) return;\n      productApi(this.productId).then(function (res) {\n        _this4.productInfo = res.data;\n      }).catch(function (err) {\n        _this4.$Message.error(err.msg);\n      });\n    },\n    // 获取订单信息\n    getOrderInfo: function getOrderInfo() {\n      var _this5 = this;\n\n      if (!this.orderId) return;\n      getOrderApi(this.orderId, {\n        token: this.userToken\n      }).then(function (res) {\n        _this5.orderInfo = res.data;\n\n        if (_this5.orderInfo.add_time_h) {\n          _this5.orderInfo.add_time_h = _this5.orderInfo.add_time_h.substring(0, _this5.orderInfo.add_time_h.lastIndexOf(':'));\n        }\n\n        if (_this5.orderInfo.cartInfo.length) {\n          _this5.cartInfo = _this5.orderInfo.cartInfo[0];\n        }\n      });\n    },\n    // 获取随机客服\n    getServiceList: function getServiceList() {\n      var _this6 = this;\n\n      serviceListApi({\n        token: this.userToken\n      }).then(function (res) {\n        _this6.toUid = res.data.uid;\n        _this6.tourist_uid = res.data.tourist_uid;\n        document.title = res.data.nickname;\n        _this6.tourist_avatar = res.data.tourist_avatar;\n\n        if (_this6.userToken) {\n          _this6.getChatList();\n        }\n\n        var obj = {\n          data: {\n            id: res.data.uid,\n            tourist_uid: _this6.tourist_uid\n          },\n          type: 'to_chat'\n        };\n\n        _this6.pageWs.then(function (ws) {\n          ws.send(obj);\n        });\n      }).catch(function (error) {\n        _this6.$Message.error(error.msg);\n\n        setTimeout(function (res) {\n          _this6.$router.replace({\n            path: '/kefu/mobile_feedback'\n          });\n        }, 2000);\n      });\n    },\n    // 上传之前\n    beforeUpload: function beforeUpload(file) {\n      var _this7 = this;\n\n      var isImage = file.type === 'image/jpeg' || file.type === 'image/png';\n\n      if (!isImage) {\n        this.$Message.error('上传图片只能是 JPG、PNG 格式!');\n      }\n\n      this.uploadData = {\n        filename: file,\n        token: this.userToken\n      };\n      var promise = new Promise(function (resolve) {\n        _this7.$nextTick(function () {\n          resolve(true);\n        });\n      });\n      return promise;\n    },\n    // 上传成功\n    handleSuccess: function handleSuccess(res, file, fileList) {\n      if (res.status === 200) {\n        this.$Message.success(res.msg);\n        this.sendMsg(res.data.url, 3);\n      } else {\n        this.$Message.error(res.msg);\n      }\n    },\n    // 滚动到底部\n    scrollBom: function scrollBom() {\n      var _this8 = this;\n\n      setTimeout(function (res) {\n        var num = parseFloat(document.getElementById('chatBox').offsetHeight);\n\n        if (_this8.$refs['scrollBox']) {\n          _this8.$refs['scrollBox'].scrollTo({\n            y: num\n          }, 300);\n        }\n      }, 300);\n    },\n    // 订单详情\n    goOrderDetail: function goOrderDetail(item) {\n      this.$router.push({\n        path: \"/kefu/orderDetail/\".concat(item.orderInfo.id)\n      });\n    },\n    // 底部功能区打开\n    openBox: function openBox(key) {\n      var _this9 = this;\n\n      if (key == 1) {\n        this.isTool = false;\n        this.isSwiper = !this.isSwiper;\n      } else {\n        this.isSwiper = false;\n        this.isTool = !this.isTool;\n      }\n\n      this.$refs['scrollBox'].refresh();\n      this.$nextTick(function () {\n        _this9.scrollBom();\n      });\n    },\n    showWords: function showWords() {\n      this.isWords = true;\n    },\n    // 转接\n    goTransfer: function goTransfer() {\n      this.isTransfer = true;\n    },\n    // 转接关闭\n    closeTransfer: function closeTransfer() {\n      this.transferList.forEach(function (el, index) {\n        el.isCheck = false;\n      });\n      this.isTransfer = false;\n    },\n    // 商品信息\n    goodsInfo: function goodsInfo() {\n      this.$router.push({\n        path: '/kefu/goods/list?toUid=' + this.toUid\n      });\n    },\n    // 表情点击\n    addEmoji: function addEmoji(item) {\n      var val = \"[\".concat(item, \"]\");\n      this.con += val;\n    },\n    // 聊天表情转换\n    replace_em: function replace_em(str) {\n      str = str.replace(/\\[em-([\\s\\S]*)\\]/g, \"<span class='em em-$1'/></span>\");\n      return str;\n    },\n    // 获取聊天列表\n    getChatList: function getChatList() {\n      var _this10 = this;\n\n      var self = this;\n      chatListApi({\n        limit: this.limit,\n        uid: this.toUid,\n        upperId: this.upperId,\n        token: this.userToken\n      }).then(function (res) {\n        var sH = 0;\n        res.data.forEach(function (el) {\n          if (el.msn_type == 1 || el.msn_type == 2) {\n            el.msn = _this10.replace_em(el.msn);\n          }\n        });\n        var selector = '';\n\n        if (_this10.upperId == 0) {\n          selector = \"chat_\".concat(res.data[res.data.length - 1].id);\n        } else {\n          selector = \"chat_\".concat(_this10.chatList[0].id);\n        }\n\n        _this10.selector = selector;\n        _this10.chatList = [].concat(_toConsumableArray(res.data), _toConsumableArray(_this10.chatList));\n        _this10.loading = false;\n        _this10.isScroll = res.data.length >= _this10.limit;\n\n        _this10.$refs['scrollBox'].refresh();\n\n        _this10.$nextTick(function () {\n          _this10.$emit('change', true);\n\n          var num = parseFloat(document.getElementById(selector).offsetTop) - 60;\n\n          _this10.$refs['scrollBox'].scrollTo({\n            y: num\n          }, 0);\n        });\n      });\n    },\n    // 发送订单\n    sendOrder: function sendOrder() {\n      this.sendMsg(this.orderId, 6);\n      this.orderId = 0;\n      this.orderInfo = {};\n    },\n    // 发送商品\n    sendProduct: function sendProduct() {\n      this.sendMsg(this.productId, 5);\n      this.productId = 0;\n      this.productInfo = {};\n    },\n    // 发送消息\n    sendText: function sendText() {\n      if (!this.isSend) {\n        this.$Message.error('请输入内容');\n      }\n\n      this.sendMsg(this.con, 1);\n      this.con = '';\n    },\n    // ws发送\n    sendMsg: function sendMsg(msn, type) {\n      var obj = {\n        type: 'chat',\n        data: {\n          msn: msn,\n          type: type,\n          is_tourist: this.userToken ? 0 : 1,\n          to_uid: this.toUid,\n          tourist_uid: this.tourist_uid,\n          form_type: this.$wechat.isWeixin() ? 1 : 3,\n          tourist_avatar: this.userToken ? '' : this.tourist_avatar\n        }\n      };\n      this.pageWs.then(function (ws) {\n        ws.send(obj);\n      });\n    },\n    // 图片上传\n    uploadImg: function uploadImg() {\n      var self = this;\n      self.$util.uploadImageOne('upload/image', function (res) {\n        if (res.status == 200) {\n          self.sendMsg(res.data.url, 3);\n        }\n      });\n    },\n    //  商品详情页\n    goProduct: function goProduct(item) {\n      var url = window.location.protocol + '//' + window.location.host + '/pages/goods_details/index?id=' + item.msn;\n      window.open(url, '_blank');\n    },\n    // 用户订单\n    goAdminOrder: function goAdminOrder() {\n      // this.$router.push({\n      //     path:'/kefu/orderList/0/'+this.toUid\n      // })\n      var url = window.location.protocol + '//' + window.location.host + '/pages/goods/order_details/index?order_id=' + item.msn;\n      window.open(url, '_blank');\n    },\n    // 滚动到底部\n    height: function height() {\n      var self = this;\n      var scrollTop = 0;\n      var info = uni.createSelectorQuery().select('.chat');\n      setTimeout(function (res) {\n        info.boundingClientRect(function (data) {\n          // data - 各种参数\n          scrollTop = data.height;\n\n          if (self.active) {\n            self.scrollTop = parseInt(scrollTop) + 500;\n          } else {\n            self.scrollTop = parseInt(scrollTop) + 100;\n          }\n        }).exec();\n      }, 1000);\n    },\n    handleActivate: function handleActivate(vm, refreshDom) {\n      this.upperId = this.chatList[0].id;\n    },\n    handleStart: function handleStart(vm, refreshDom, done) {\n      setTimeout(function () {\n        // load finished\n        done();\n      }, 2000);\n    },\n    handleBeforeDeactivate: function handleBeforeDeactivate(vm, refreshDom, done) {\n      if (this.userToken) {\n        this.getChatList();\n        this.$on('change', function (data) {\n          if (data) done();\n        });\n      } else {\n        done();\n      }\n    },\n    handleDeactivate: function handleDeactivate(vm, refreshDom) {\n      var num = parseFloat(document.getElementById(this.selector).offsetTop) - 60;\n      this.$refs['scrollBox'].scrollTo({\n        y: num\n      }, 0);\n    }\n  }\n};",null]}