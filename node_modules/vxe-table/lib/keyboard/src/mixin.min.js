"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_tools=require("../../tools"),_dom=require("../../tools/src/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getTargetOffset(e,t){var o,l,n=0,r=0,s=!_dom.browse.firefox&&_tools.DomTools.hasClass(e,"vxe-checkbox--label");for(s&&(o=getComputedStyle(e),n-=_xeUtils.default.toNumber(o.paddingTop),r-=_xeUtils.default.toNumber(o.paddingLeft));e&&e!==t;)n+=e.offsetTop,r+=e.offsetLeft,e=e.offsetParent,s&&(l=getComputedStyle(e),n-=_xeUtils.default.toNumber(l.paddingTop),r-=_xeUtils.default.toNumber(l.paddingLeft));return{offsetTop:n,offsetLeft:r}}function getCheckboxRangeRows(e,t,o,l){var n=0,r=[],s=0<l,i=0<l?l:Math.abs(l)+o.offsetHeight,c=e.afterFullData,l=e.scrollYStore;if(e.scrollYLoad)t=e.getVTRowIndex(t.row),r=s?c.slice(t,t+Math.ceil(i/l.rowHeight)):c.slice(t-Math.floor(i/l.rowHeight)+1,t+1);else for(var a=s?"next":"previous";o&&n<i;)r.push(e.getRowNode(o).item),n+=o.offsetHeight,o=o["".concat(a,"ElementSibling")];return r}var _default={methods:{moveTabSelected:function(e,t,o){var l,n,r,s=this,i=this.afterFullData,c=this.visibleColumn,a=this.editConfig,u=this.editOpts,h=Object.assign({},e),d=this.getVTRowIndex(h.row),e=this.getVTColumnIndex(h.column);o.preventDefault(),t?e<=0?0<d&&(l=i[n=d-1],r=c.length-1):r=e-1:e>=c.length-1?d<i.length-1&&(l=i[n=d+1],r=0):r=e+1;c=c[r];c&&(l?(h.rowIndex=n,h.row=l):h.rowIndex=d,h.columnIndex=r,h.column=c,h.cell=this.getCell(h.row,h.column),a?"click"!==u.trigger&&"dblclick"!==u.trigger||("row"===u.mode?this.handleActived(h,o):this.scrollToRow(h.row,h.column).then(function(){return s.handleSelected(h,o)})):this.scrollToRow(h.row,h.column).then(function(){return s.handleSelected(h,o)}))},moveCurrentRow:function(e,t,o){var l,n,r,s=this,i=this.currentRow,c=this.treeConfig,a=this.treeOpts,u=this.afterFullData;o.preventDefault(),i?c?(n=(a=_xeUtils.default.findTree(u,function(e){return e===i},a)).index,a=a.items,e&&0<n?l=a[n-1]:t&&n<a.length-1&&(l=a[n+1])):(n=this.getVTRowIndex(i),e&&0<n?l=u[n-1]:t&&n<u.length-1&&(l=u[n+1])):l=u[0],l&&(r={$table:this,row:l},this.scrollToRow(l).then(function(){return s.triggerCurrentRowEvent(o,r)}))},moveSelected:function(e,t,o,l,n,r){var s=this,i=this.afterFullData,c=this.visibleColumn,a=Object.assign({},e),u=this.getVTRowIndex(a.row),e=this.getVTColumnIndex(a.column);r.preventDefault(),o&&0<u?(a.rowIndex=u-1,a.row=i[a.rowIndex]):n&&u<i.length-1?(a.rowIndex=u+1,a.row=i[a.rowIndex]):t&&e?(a.columnIndex=e-1,a.column=c[a.columnIndex]):l&&e<c.length-1&&(a.columnIndex=e+1,a.column=c[a.columnIndex]),this.scrollToRow(a.row,a.column).then(function(){a.cell=s.getCell(a.row,a.column),s.handleSelected(a,r)})},triggerHeaderCellMousedownEvent:function(e,t){var o,l=this.mouseConfig,n=this.mouseOpts;l&&n.area&&this.handleHeaderCellAreaEvent&&(o=e.currentTarget,l=_tools.DomTools.getEventTargetNode(e,o,"vxe-cell--sort").flag,n=_tools.DomTools.getEventTargetNode(e,o,"vxe-cell--filter").flag,this.handleHeaderCellAreaEvent(e,Object.assign({cell:o,triggerSort:l,triggerFilter:n},t))),this.focus(),this.closeMenu()},triggerCellMousedownEvent:function(e,t){var o=e.currentTarget;t.cell=o,this.handleCellMousedownEvent(e,t),this.focus(),this.closeFilter(),this.closeMenu()},handleCellMousedownEvent:function(e,t){var o=this.editConfig,l=this.editOpts,n=this.handleSelected,r=this.checkboxConfig,s=this.checkboxOpts,i=this.mouseConfig,c=this.mouseOpts;if(i&&c.area&&this.handleCellAreaEvent)return this.handleCellAreaEvent(e,t);r&&s.range&&this.handleCheckboxRangeEvent(e,t),i&&c.selected&&(o&&"cell"!==l.mode||n(t,e))},handleCheckboxRangeEvent:function(e,i){var t,o,c,a,u,h,l,n,d,f,g,m,x,v,p,w,b,T,C,R,_,k,r,I=this,s=i.column,D=i.cell;"checkbox"===s.type&&(t=this.$el,o=this.elemStore,c=e.clientX,a=e.clientY,u=o["".concat(s.fixed||"main","-body-wrapper")]||o["main-body-wrapper"],h=u.querySelector(".vxe-table--checkbox-range"),l=document.onmousemove,n=document.onmouseup,d=D.parentNode,f=this.getCheckboxRecords(),g=[],m=1,D=getTargetOffset(e.target,u),x=D.offsetTop+e.offsetY,v=D.offsetLeft+e.offsetX,p=u.scrollTop,w=d.offsetHeight,b=null,T=!1,C=1,R=function(e,t){I.emitEvent("checkbox-range-".concat(e),{records:I.getCheckboxRecords(),reserves:I.getCheckboxReserveRecords()},t)},_=function(e){var t=e.clientX,o=e.clientY,l=t-c,n=o-a+(u.scrollTop-p),r=Math.abs(n),s=Math.abs(l),t=x,o=v;n<m?(t+=n)<m&&(t=m,r=x):r=Math.min(r,u.scrollHeight-x-m),l<m?(o+=l,v<s&&(o=m,s=v)):s=Math.min(s,u.clientWidth-v-m),h.style.height="".concat(r,"px"),h.style.width="".concat(s,"px"),h.style.left="".concat(o,"px"),h.style.top="".concat(t,"px"),h.style.display="block";n=getCheckboxRangeRows(I,i,d,n<m?-r:r);10<r&&n.length!==g.length&&(g=n,e.ctrlKey?n.forEach(function(e){I.handleSelectRow({row:e},-1===f.indexOf(e))}):(I.setAllCheckboxRow(!1),I.setCheckboxRow(n,!0)),R("change",e))},k=function(){clearTimeout(b),b=null},r=function r(s){k(),b=setTimeout(function(){var e,t,o,l,n;b&&(e=u.scrollLeft,t=u.scrollTop,o=u.clientHeight,l=u.scrollHeight,n=Math.ceil(50*C/w),T?t+o<l?(I.scrollTo(e,t+n),r(s),_(s)):k():t?(I.scrollTo(e,t-n),r(s),_(s)):k())},50)},_tools.DomTools.addClass(t,"drag--range"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var t=e.clientY,o=_tools.DomTools.getAbsolutePos(u).boundingTop;t<o?(T=!1,C=o-t,b||r(e)):t>o+u.clientHeight?(T=!0,C=t-o-u.clientHeight,b||r(e)):b&&k(),_(e)},document.onmouseup=function(e){k(),_tools.DomTools.removeClass(t,"drag--range"),h.removeAttribute("style"),document.onmousemove=l,document.onmouseup=n,R("end",e)},R("start",e))}}};exports.default=_default;